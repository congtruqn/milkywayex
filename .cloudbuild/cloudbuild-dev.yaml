# build
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', 
  '--tag=gcr.io/$PROJECT_ID/components-nginx:$BRANCH_NAME', 
  '--file=services/components-nginx/Dockerfile', "."]
# push
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/components-nginx:$BRANCH_NAME']

# deploy
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['run', 'deploy', 
  '$BRANCH_NAME-dot-components-nginx-dot-brights-bros', 
  '--project=brights-bros', 
  '--image=gcr.io/$PROJECT_ID/components-nginx:$BRANCH_NAME', 
  '--port=80', '--timeout=900',
  '--allow-unauthenticated', '--region=asia-northeast1']

# policy
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['run', 'services', 'add-iam-policy-binding', 
  '--project=brights-bros','--platform=managed', 
  '--region=asia-northeast1', '$BRANCH_NAME-dot-components-nginx-dot-brights-bros', '--member=allUsers', '--role=roles/run.invoker']
timeout: "1600s"